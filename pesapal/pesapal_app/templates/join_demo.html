{% extends 'base.html' %}

{% block title %}JOIN Demo - PesapalDB{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-shuffle me-2"></i> JOIN Demo
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="/" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-house me-1"></i> Dashboard
                </a>
                <a href="/terminal/" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-terminal me-1"></i> SQL Terminal
                </a>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Error</h4>
        <p>{{ error }}</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% else %}

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">JOIN Type</h6>
                    <h3 class="card-title text-primary">{{ join_type }} JOIN</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Rows</h6>
                    <h3 class="card-title text-success">{{ total_rows }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Users with Orders</h6>
                    <h3 class="card-title text-info">{{ users_with_orders }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Orders with Users</h6>
                    <h3 class="card-title text-warning">{{ orders_with_users }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-filter me-2"></i>JOIN Type Selector</h5>
        </div>
        <div class="card-body">
            <div class="btn-group" role="group" aria-label="JOIN types">
                {% for type in join_types %}
                <a href="?type={{ type }}" 
                   class="btn {% if type == join_type %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    <i class="bi bi-arrow-left-right me-1"></i>{{ type }} JOIN
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-code-slash me-2"></i>SQL Equivalent</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded"><code>SELECT * 
FROM users 
{{ join_type }} JOIN orders ON users.id = orders.user_id</code></pre>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>What This Means</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% if join_type == 'INNER' %}
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Returns only users who have orders AND orders that have users
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-x-circle text-danger me-2"></i>
                            Excludes: Users without orders AND orders without users
                        </li>
                        {% elif join_type == 'LEFT' %}
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Returns ALL users, with their orders if they have any
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-dash-circle text-warning me-2"></i>
                            Users without orders appear with NULL order columns
                        </li>
                        {% elif join_type == 'RIGHT' %}
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Returns ALL orders, with their users if they exist
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-dash-circle text-warning me-2"></i>
                            Orders without users appear with NULL user columns
                        </li>
                        {% elif join_type == 'FULL' %}
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Returns ALL users AND ALL orders
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-dash-circle text-warning me-2"></i>
                            Missing matches appear as NULLs
                        </li>
                        {% elif join_type == 'CROSS' %}
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Returns EVERY combination of users and orders
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-arrow-left-right text-info me-2"></i>
                            No relationship needed - just all possible pairs
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Results ({{ results|length }} rows)</h5>
            <span class="badge bg-primary">{{ results|length }} rows</span>
        </div>
        <div class="card-body">
            {% if results %}
            <div class="table-responsive" style="max-height: 500px;">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            {% for key in results.0.keys %}
                            <th class="{% if 'users.' in key %}table-primary{% elif 'orders.' in key %}table-info{% endif %}">
                                {% if 'users.' in key %}
                                <i class="bi bi-person me-1"></i>
                                {% elif 'orders.' in key %}
                                <i class="bi bi-cart me-1"></i>
                                {% endif %}
                                {{ key }}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in results %}
                        <tr>
                            {% for key, value in row.items %}
                            <td class="{% if value is None %}text-muted fst-italic{% endif %}">
                                {% if value is None %}
                                <span class="badge bg-secondary">NULL</span>
                                {% else %}
                                {{ value }}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-table text-muted" style="font-size: 3rem;"></i>
                <h4 class="mt-3 text-muted">No Results Found</h4>
                <p class="text-muted">Try a different JOIN type or create some data first</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% endif %}
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const nullCells = document.querySelectorAll('.text-muted.fst-italic');
        nullCells.forEach(cell => {
            cell.addEventListener('mouseenter', function() {
                this.classList.add('bg-warning', 'bg-opacity-10');
            });
            cell.addEventListener('mouseleave', function() {
                this.classList.remove('bg-warning', 'bg-opacity-10');
            });
        });

        const joinButtons = document.querySelectorAll('.btn-group .btn');
        const joinTooltips = {
            'INNER': 'Only matching rows from both tables',
            'LEFT': 'All rows from users + matching orders',
            'RIGHT': 'All rows from orders + matching users', 
            'FULL': 'All rows from both tables',
            'CROSS': 'All possible combinations'
        };

        joinButtons.forEach(button => {
            const joinType = button.textContent.replace(' JOIN', '').trim();
            if (joinTooltips[joinType]) {
                button.setAttribute('title', joinTooltips[joinType]);
                button.setAttribute('data-bs-toggle', 'tooltip');
            }
        });

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
</script>
{% endblock %}

{% endblock %}