{% extends 'base.html' %}

{% block title %}SQL Terminal - PesapalDB{% endblock %}

{% block extra_css %}
<style>
    .terminal-container {
        background: #1e1e1e;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 1rem;
        font-size: 0.8em;
    }
    
    .terminal-header {
        background: #252526;
        padding: 1rem;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .terminal-body {
        padding: 1rem;
        font-family: 'Courier New', monospace;
        color: #d4d4d4;
        height:28em;
        overflow-y: auto;
        overflow-anchor: none;
    }
    
    .terminal-line {
        margin: 0.5rem 0;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .terminal-prompt {
        color: #4ec9b0;
        font-weight: bold;
    }
    
    .terminal-input {
        background: transparent;
        border: none;
        color: #d4d4d4;
        font-family: inherit;
        font-size: inherit;
        flex: 1;
        outline: none;
        padding-left: 0.5rem;
    }
    
    .terminal-query {
        color: #569cd6;
    }
    
    .terminal-success {
        color: #4ec9b0;
    }
    
    .terminal-error {
        color: #f44747;
    }
    
    .terminal-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        background: #252526;
        font-size: 0.8em;
    }
    
    .terminal-table th {
        background: #2d2d30;
        color: #9cdcfe;
        padding: 0.5rem;
        text-align: left;
        border: 1px solid #3e3e42;
        font-weight: 600;
    }
    
    .terminal-table td {
        padding: 0.5rem;
        border: 1px solid #3e3e42;
        color: #ce9178;
    }
    
    .controls {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: calc(100% - 1rem);
        display: flex;
        flex-direction: column;
    }
    
    .history-panel {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        height: 300px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .history-list {
        flex: 1;
        overflow-y: auto;
        margin-top: 0.5rem;
    }
    
    .history-item {
        padding: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        font-size: 0.7em;
        transition: background-color 0.2s;
    }
    
    .history-item:hover {
        background: #f8fafc;
    }
    
    .terminal-input-container {
        display: flex;
        align-items: center;
        padding: 0 1rem 1rem;
        background: #252526;
    }
    
    .query-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .query-status.success {
        background-color: #4ec9b0;
    }
    
    .query-status.error {
        background-color: #f44747;
    }
    
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #4ec9b0;
        box-shadow: 0 0 8px rgba(78, 201, 176, 0.8);
    }
    
    /* Enhanced Quick Examples styling */
    .quick-examples-card {
        height: 100%;
        min-height: 250px;
    }
    
    .quick-examples-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        height: 100%;
    }
    
    .example-btn {
        height: 100%;
        min-height: 70px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 15px !important;
        text-align: center;
        white-space: normal;
        word-break: break-word;
        line-height: 1.4;
    }
    
    .example-btn i {
        font-size: 1.2em;
        margin-bottom: 8px;
    }
    
    .example-description {
        font-size: 0.75em;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .example-btn:hover .example-description {
        color: #ffffff;
    }
    
    /* Make the right column taller */
    .col-lg-3 {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 150px);
    }
    
    .col-lg-3 > div {
        flex-shrink: 0;
    }
    
    .col-lg-3 > .controls {
        flex: 0 0 auto;
    }
    
    .col-lg-3 > .history-panel {
        flex: 1;
        height: auto;
        min-height: 200px;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h3">
        <i class="bi bi-terminal me-2"></i>PesapalDB SQL Terminal
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="clearTerminal()">
                <i class="bi bi-trash me-1"></i> Clear
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="showHelp()">
                <i class="bi bi-question-circle me-1"></i> Help
            </button>
        </div>
    </div>
</div>

<div class="row" style="min-height: calc(100vh - 200px);">
    <div class="col-lg-9">
        <div class="terminal-container">
            <div class="terminal-header">
                <div>
                    <span class="text-light fw-bold">PesapalDB Terminal</span>
                    <small class="text-muted ms-2">Connected to: {{ schema.name|default:"pesapal_db" }}</small>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span class="text-light">Online</span>
                </div>
            </div>
            <div class="terminal-body" id="terminalOutput">
                <div class="terminal-line terminal-success">=== PesapalDB SQL Terminal ===</div>
                <div class="terminal-line">Type SQL commands and press Enter</div>
                <div class="terminal-line">Type 'help' for available commands</div>
                <div>Scroll down to see and click Quick Examples</div>
                <div class="terminal-line terminal-success">Ready!</div>
            </div>
            <div class="terminal-input-container">
                <span class="terminal-prompt">SQL></span>
                <input type="text" class="terminal-input" id="terminalInput" 
                       placeholder="Enter SQL command..." autofocus
                       onkeydown="handleTerminalKey(event)">
            </div>
        </div>
        
        <!-- Moved Quick Examples here to cover the space below terminal -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card quick-examples-card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-lightbulb me-2"></i> Quick Examples
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="quick-examples-grid">
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('SELECT * FROM users')">
                                    <i class="bi bi-eye"></i>
                                    SELECT * FROM users
                                    <div class="example-description">View all users</div>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('SELECT * FROM products')">
                                    <i class="bi bi-box"></i>
                                    SELECT * FROM products
                                    <div class="example-description">View all products</div>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL,email TEXT UNIQUE NOT NULL,age INTEGER, created_at TEXT DEFAULT CURRENT_TIMESTAMP);')">
                                    <i class="bi bi-table"></i>
                                    Create New Table
                                    <div class="example-description">Create a test table</div>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('INSERT INTO users (name, email, is_active) VALUES (\\'John Doe\\', \\'john@example.com\\', true)')">
                                    <i class="bi bi-plus-circle"></i>
                                    Insert Data
                                    <div class="example-description">Add new user</div>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('UPDATE users SET is_active = true WHERE email = \\'john@example.com\\'')">
                                    <i class="bi bi-pencil"></i>
                                    Update Data
                                    <div class="example-description">Modify user status</div>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('SELECT users.name, orders.total FROM users JOIN orders ON users.id = orders.user_id')">
                                    <i class="bi bi-shuffle"></i>
                                    JOIN Example
                                    <div class="example-description">Combine tables</div>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('SELECT COUNT(*) as total_users, AVG(age) as avg_age FROM users')">
                                    <i class="bi bi-calculator"></i>
                                    Aggregate Functions
                                    <div class="example-description">Count & average</div>
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary w-100 example-btn" 
                                        onclick="insertExample('SCHEMA')">
                                    <i class="bi bi-diagram-3"></i>
                                    Show Schema
                                    <div class="example-description">View database structure</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <div class="controls">
            <h6 class="mb-3">
                <i class="bi bi-gear me-2"></i> Settings
            </h6>
            <div class="mb-3">
                <label class="form-label small mb-1">Output Format:</label>
                <select class="form-select form-select-sm" id="outputFormat">
                    <option value="table">Table View</option>
                    <option value="json">JSON</option>
                    <option value="raw">Raw Output</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label small mb-1">Row Limit:</label>
                <input type="number" class="form-control form-control-sm" 
                       id="rowLimit" value="100" min="1" max="1000">
            </div>
            <div class="mb-3">
                <label class="form-label small mb-1">Auto-execute:</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoExecute" checked>
                    <label class="form-check-label" for="autoExecute">Execute on Enter</label>
                </div>
            </div>
        </div>
        
        <div class="history-panel">
            <h6 class="mb-2">
                <i class="bi bi-clock-history me-2"></i> Command History
                <button class="btn btn-sm btn-outline-secondary float-end py-0" 
                        onclick="clearHistory()">Clear</button>
            </h6>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
const terminalOutput = document.getElementById('terminalOutput');
const terminalInput = document.getElementById('terminalInput');
const outputFormat = document.getElementById('outputFormat');
const rowLimit = document.getElementById('rowLimit');
const autoExecute = document.getElementById('autoExecute');
const csrfToken = "{{ csrf_token }}";

let commandHistory = JSON.parse(localStorage.getItem('pesapalTerminalHistory') || '[]');
let historyIndex = -1;

// FORCE terminal to stay at TOP - multiple attempts
terminalOutput.scrollTop = 0;

document.addEventListener('DOMContentLoaded', function() {
    terminalOutput.scrollTop = 0;
    updateHistoryDisplay();
    terminalInput.focus();
});

window.addEventListener('load', function() {
    terminalOutput.scrollTop = 0;
});

// Extra safeguard
setTimeout(function() {
    terminalOutput.scrollTop = 0;
}, 0);

setTimeout(function() {
    terminalOutput.scrollTop = 0;
}, 100);

function handleTerminalKey(e) {
    if (e.key === 'Enter' && autoExecute.checked) {
        executeCommand();
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateHistory(-1);
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateHistory(1);
    }
}

function addToHistory(command) {
    if (command.trim() && !commandHistory.includes(command)) {
        commandHistory.push(command);
        if (commandHistory.length > 50) {
            commandHistory.shift();
        }
        localStorage.setItem('pesapalTerminalHistory', JSON.stringify(commandHistory));
        updateHistoryDisplay();
    }
    historyIndex = -1;
}

function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    commandHistory.slice().reverse().forEach(cmd => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.textContent = cmd.length > 40 ? cmd.substring(0, 40) + '...' : cmd;
        div.onclick = () => {
            terminalInput.value = cmd;
            terminalInput.focus();
        };
        historyList.appendChild(div);
    });
}

function navigateHistory(direction) {
    if (commandHistory.length === 0) return;
    
    if (direction === -1 && historyIndex < commandHistory.length - 1) {
        historyIndex++;
    } else if (direction === 1 && historyIndex > 0) {
        historyIndex--;
    } else if (direction === 1 && historyIndex === 0) {
        historyIndex = -1;
        terminalInput.value = '';
        return;
    }
    
    terminalInput.value = commandHistory[commandHistory.length - 1 - historyIndex];
}

function addTerminalLine(content, className = '') {
    const line = document.createElement('div');
    line.className = `terminal-line ${className}`;
    line.innerHTML = content;
    terminalOutput.appendChild(line);
    
    // Auto-scroll to bottom to show new content
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function executeCommand() {
    const command = terminalInput.value.trim();
    if (!command) return;
    
    addTerminalLine(`<span class="terminal-prompt">SQL></span> <span class="terminal-query">${escapeHtml(command)}</span>`);
    
    if (command.toLowerCase() === 'clear') {
        clearTerminal();
        terminalInput.value = '';
        return;
    }
    
    if (command.toLowerCase() === 'help') {
        showHelp();
        terminalInput.value = '';
        return;
    }
    
    if (command.toUpperCase() === 'SCHEMA') {
        try {
            const response = await fetch('/api/schema/');
            const data = await response.json();
            
            if (data.tables) {
                addTerminalLine('<span class="terminal-success">Database Schema:</span>');
                for (const [tableName, tableInfo] of Object.entries(data.tables)) {
                    addTerminalLine(`  <strong>${tableName}</strong> (${tableInfo.row_count} rows):`);
                    for (const col of tableInfo.columns) {
                        const constraints = [];
                        if (col.primary) constraints.push('PK');
                        if (col.unique) constraints.push('UNIQUE');
                        if (!col.nullable) constraints.push('NOT NULL');
                        const constrStr = constraints.length ? ` [${constraints.join(', ')}]` : '';
                        addTerminalLine(`    ${col.name}: ${col.type}${constrStr}`);
                    }
                }
                addTerminalLine(`<span class="terminal-success">✓ Query successful</span>`);
            } else {
                addTerminalLine('<span class="terminal-error">✗ Invalid schema response</span>');
            }
        } catch (error) {
            addTerminalLine(`<span class="terminal-error">✗ Error: ${error}</span>`);
        }
        
        addToHistory(command);
        terminalInput.value = '';
        return;
    }
    
    try {
        const response = await fetch('/terminal/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'query': command,
                'format': outputFormat.value,
                'limit': rowLimit.value
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (outputFormat.value === 'table' && Array.isArray(data.result)) {
                displayAsTable(data.result);
            } else if (outputFormat.value === 'json') {
                displayAsJson(data.result);
            } else {
                const result = data.result || 'Query executed successfully';
                if (typeof result === 'string') {
                    addTerminalLine(result, 'terminal-success');
                } else {
                    addTerminalLine(JSON.stringify(result), 'terminal-success');
                }
            }
            addTerminalLine(`<span class="terminal-success">✓ Query successful</span>`);
        } else {
            addTerminalLine(`<span class="terminal-error">✗ Error: ${data.error}</span>`);
        }
    } catch (error) {
        addTerminalLine(`<span class="terminal-error">✗ Request failed: ${error}</span>`);
    }
    
    addToHistory(command);
    terminalInput.value = '';
}

function displayAsTable(data) {
    if (!data || !Array.isArray(data) || data.length === 0) {
        addTerminalLine('Empty result set', 'terminal-success');
        return;
    }
    
    const firstRow = data[0];
    if (!firstRow || typeof firstRow !== 'object') {
        addTerminalLine(JSON.stringify(data), 'terminal-success');
        return;
    }
    
    const table = document.createElement('table');
    table.className = 'terminal-table';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    Object.keys(firstRow).forEach(key => {
        const th = document.createElement('th');
        th.textContent = key;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    const limit = parseInt(rowLimit.value);
    const rowsToShow = Math.min(data.length, limit);
    
    for (let i = 0; i < rowsToShow; i++) {
        const rowData = data[i];
        const row = document.createElement('tr');
        
        Object.values(rowData).forEach(value => {
            const td = document.createElement('td');
            td.textContent = value !== null && value !== undefined ? value : 'NULL';
            row.appendChild(td);
        });
        
        tbody.appendChild(row);
    }
    table.appendChild(tbody);
    
    terminalOutput.appendChild(table);
    
    // Auto-scroll after adding table
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
    
    addTerminalLine(`Showing ${rowsToShow} of ${data.length} row(s)`, 'terminal-success');
    
    if (data.length > limit) {
        addTerminalLine(`Limited to ${limit} rows`, 'terminal-success');
    }
}

function displayAsJson(data) {
    const pre = document.createElement('pre');
    pre.style.cssText = 'background: #252526; padding: 1rem; border-radius: 4px; margin: 1rem 0; white-space: pre-wrap;';
    pre.textContent = JSON.stringify(data, null, 2);
    terminalOutput.appendChild(pre);
    
    // Auto-scroll after adding JSON
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

function clearTerminal() {
    terminalOutput.innerHTML = '';
    addTerminalLine('<span class="terminal-success">=== PesapalDB SQL Terminal ===</span>');
    addTerminalLine('Terminal cleared. Type SQL commands and press Enter.');
    
    // Scroll to top after clearing
    terminalOutput.scrollTop = 0;
}

function clearHistory() {
    if (confirm('Clear command history?')) {
        commandHistory = [];
        localStorage.removeItem('pesapalTerminalHistory');
        updateHistoryDisplay();
    }
}

function showHelp() {
    addTerminalLine('<span class="terminal-success">SQL Commands:</span>');
    addTerminalLine('  SELECT * FROM table_name [WHERE condition]');
    addTerminalLine('  INSERT INTO table_name (col1, col2) VALUES (val1, val2)');
    addTerminalLine('  UPDATE table_name SET col=val [WHERE condition]');
    addTerminalLine('  DELETE FROM table_name [WHERE condition]');
    addTerminalLine('  CREATE TABLE name (col TYPE [PRIMARY KEY|UNIQUE|NOT NULL], ...)');
    addTerminalLine('  DROP TABLE table_name');
    addTerminalLine('  CREATE INDEX idx_name ON table_name(column)');
    addTerminalLine('');
    addTerminalLine('<span class="terminal-success">Special Commands:</span>');
    addTerminalLine('  SCHEMA - Show database schema');
    addTerminalLine('  help  - Show this help');
    addTerminalLine('  clear - Clear terminal');
}

function insertExample(sql) {
    terminalInput.value = sql.replace(/\\'/g, "'");
    terminalInput.focus();
}
</script>
{% endblock %}