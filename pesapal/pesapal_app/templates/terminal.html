{% extends 'base.html' %}

{% block title %}SQL Terminal - PesapalDB{% endblock %}

{% block extra_css %}
<style>
    .terminal-container {
        background: #1e1e1e;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 1rem;
    }
    
    .terminal-header {
        background: #252526;
        padding: 1rem;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .terminal-body {
        padding: 1rem;
        font-family: 'Courier New', monospace;
        color: #d4d4d4;
        height: 500px;
        overflow-y: auto;
    }
    
    .terminal-line {
        margin: 0.5rem 0;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .terminal-prompt {
        color: #4ec9b0;
        font-weight: bold;
    }
    
    .terminal-input {
        background: transparent;
        border: none;
        color: #d4d4d4;
        font-family: inherit;
        font-size: inherit;
        flex: 1;
        outline: none;
        padding-left: 0.5rem;
    }
    
    .terminal-query {
        color: #569cd6;
    }
    
    .terminal-success {
        color: #4ec9b0;
    }
    
    .terminal-error {
        color: #f44747;
    }
    
    .terminal-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        background: #252526;
        font-size: 0.9rem;
    }
    
    .terminal-table th {
        background: #2d2d30;
        color: #9cdcfe;
        padding: 0.5rem;
        text-align: left;
        border: 1px solid #3e3e42;
        font-weight: 600;
    }
    
    .terminal-table td {
        padding: 0.5rem;
        border: 1px solid #3e3e42;
        color: #ce9178;
    }
    
    .controls {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .history-panel {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        height: 300px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .history-list {
        flex: 1;
        overflow-y: auto;
        margin-top: 0.5rem;
    }
    
    .history-item {
        padding: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        transition: background-color 0.2s;
    }
    
    .history-item:hover {
        background: #f8fafc;
    }
    
    .terminal-input-container {
        display: flex;
        align-items: center;
        padding: 0 1rem 1rem;
        background: #252526;
    }
    
    .query-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .query-status.success {
        background-color: #4ec9b0;
    }
    
    .query-status.error {
        background-color: #f44747;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-terminal me-2"></i>PesapalDB SQL Terminal
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="clearTerminal()">
                <i class="bi bi-trash me-1"></i> Clear
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="showHelp()">
                <i class="bi bi-question-circle me-1"></i> Help
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-9">
        <div class="terminal-container">
            <div class="terminal-header">
                <div>
                    <span class="text-light fw-bold">PesapalDB Terminal</span>
                    <small class="text-muted ms-2">Connected to: {{ schema.name }}</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success rounded-circle p-1 me-1"></span>
                    <span class="text-light">Online</span>
                </div>
            </div>
            <div class="terminal-body" id="terminalOutput">
                <div class="terminal-line terminal-success">=== PesapalDB SQL Terminal ===</div>
                <div class="terminal-line">Type SQL commands and press Enter</div>
                <div class="terminal-line">Type 'help' for available commands</div>
                <div class="terminal-line terminal-success">Ready!</div>
            </div>
            <div class="terminal-input-container">
                <span class="terminal-prompt">SQL></span>
                <input type="text" class="terminal-input" id="terminalInput" 
                       placeholder="Enter SQL command..." autofocus
                       onkeydown="handleTerminalKey(event)">
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <div class="controls">
            <h6 class="mb-3">
                <i class="bi bi-gear me-2"></i> Settings
            </h6>
            <div class="mb-3">
                <label class="form-label small mb-1">Output Format:</label>
                <select class="form-select form-select-sm" id="outputFormat">
                    <option value="table">Table View</option>
                    <option value="json">JSON</option>
                    <option value="raw">Raw Output</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label small mb-1">Row Limit:</label>
                <input type="number" class="form-control form-control-sm" 
                       id="rowLimit" value="100" min="1" max="1000">
            </div>
            <div class="mb-3">
                <label class="form-label small mb-1">Auto History:</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" 
                           id="autoHistory" checked>
                    <label class="form-check-label small" for="autoHistory">
                        Save to history
                    </label>
                </div>
            </div>
        </div>
        
        <div class="history-panel">
            <h6 class="mb-2">
                <i class="bi bi-clock-history me-2"></i> Command History
                <button class="btn btn-sm btn-outline-secondary float-end py-0" 
                        onclick="clearHistory()">Clear</button>
            </h6>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightbulb me-2"></i> Quick Examples
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-3">
                        <button class="btn btn-sm btn-outline-primary w-100" 
                                onclick="insertExample('SELECT * FROM users')">
                            SELECT * FROM users
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-sm btn-outline-primary w-100" 
                                onclick="insertExample('CREATE TABLE test (id INT PRIMARY KEY, name TEXT)')">
                            Create Table
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-sm btn-outline-primary w-100" 
                                onclick="insertExample('INSERT INTO users (name, email) VALUES (\\'Test\\', \\'test@example.com\\')')">
                            Insert Data
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-sm btn-outline-primary w-100" 
                                onclick="insertExample('SCHEMA')">
                            Show Schema
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const terminalOutput = document.getElementById('terminalOutput');
const terminalInput = document.getElementById('terminalInput');
const outputFormat = document.getElementById('outputFormat');
const rowLimit = document.getElementById('rowLimit');
const autoHistory = document.getElementById('autoHistory');
const csrfToken = "{{ csrf_token }}";

let commandHistory = JSON.parse(localStorage.getItem('pesapalTerminalHistory') || '[]');
let historyIndex = -1;
let currentHistory = [];

function handleTerminalKey(e) {
    if (e.key === 'Enter') {
        executeCommand();
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateHistory(-1);
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateHistory(1);
    }
}

function addToHistory(command) {
    if (command.trim() && autoHistory.checked) {
        if (!commandHistory.includes(command)) {
            commandHistory.push(command);
            if (commandHistory.length > 100) {
                commandHistory.shift();
            }
            localStorage.setItem('pesapalTerminalHistory', JSON.stringify(commandHistory));
        }
        currentHistory.push(command);
        if (currentHistory.length > 10) {
            currentHistory.shift();
        }
        updateHistoryDisplay();
    }
    historyIndex = -1;
}

function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    const recentHistory = commandHistory.slice(-20).reverse();
    
    recentHistory.forEach(cmd => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
            <div class="query-status success"></div>
            <span class="text-truncate">${escapeHtml(cmd.substring(0, 60))}</span>
        `;
        div.onclick = () => {
            terminalInput.value = cmd;
            terminalInput.focus();
        };
        historyList.appendChild(div);
    });
}

function clearHistory() {
    commandHistory = [];
    currentHistory = [];
    localStorage.removeItem('pesapalTerminalHistory');
    updateHistoryDisplay();
}

function navigateHistory(direction) {
    if (currentHistory.length === 0) return;
    
    if (direction === -1) {
        if (historyIndex < currentHistory.length - 1) {
            historyIndex++;
            terminalInput.value = currentHistory[currentHistory.length - 1 - historyIndex];
        }
    } else if (direction === 1 && historyIndex > 0) {
        historyIndex--;
        terminalInput.value = currentHistory[currentHistory.length - 1 - historyIndex];
    } else if (direction === 1 && historyIndex === 0) {
        historyIndex = -1;
        terminalInput.value = '';
    }
}

function addTerminalLine(content, className = '') {
    const line = document.createElement('div');
    line.className = `terminal-line ${className}`;
    line.innerHTML = content;
    terminalOutput.appendChild(line);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function executeCommand() {
    const command = terminalInput.value.trim();
    if (!command) return;
    
    addTerminalLine(`<span class="terminal-prompt">SQL></span> <span class="terminal-query">${escapeHtml(command)}</span>`);
    
    if (command.toLowerCase() === 'clear') {
        clearTerminal();
        terminalInput.value = '';
        return;
    }
    
    if (command.toLowerCase() === 'help') {
        showHelp();
        terminalInput.value = '';
        return;
    }
    
    if (command.toUpperCase() === 'SCHEMA') {
        try {
            const response = await fetch('/api/schema/');
            const data = await response.json();
            
            if (data.tables) {
                addTerminalLine('<span class="terminal-success">Database Schema:</span>');
                for (const [tableName, tableInfo] of Object.entries(data.tables)) {
                    addTerminalLine(`  <strong>${tableName}</strong> (${tableInfo.row_count} rows):`);
                    for (const col of tableInfo.columns) {
                        const constraints = [];
                        if (col.primary) constraints.push('PK');
                        if (col.unique) constraints.push('UNIQUE');
                        if (!col.nullable) constraints.push('NOT NULL');
                        const constrStr = constraints.length ? ` [${constraints.join(', ')}]` : '';
                        addTerminalLine(`    ${col.name}: ${col.type}${constrStr}`);
                    }
                }
                addTerminalLine(`<span class="terminal-success">✓ Query successful</span>`);
            } else {
                addTerminalLine('<span class="terminal-error">✗ Invalid schema response</span>');
            }
        } catch (error) {
            addTerminalLine(`<span class="terminal-error">✗ Error: ${error}</span>`);
        }
        
        addToHistory(command);
        terminalInput.value = '';
        return;
    }
    
    try {
        const response = await fetch('/terminal/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'query': command,
                'format': outputFormat.value,
                'limit': rowLimit.value
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (outputFormat.value === 'table' && Array.isArray(data.result)) {
                displayAsTable(data.result);
            } else if (outputFormat.value === 'json') {
                displayAsJson(data.result);
            } else {
                const result = data.result || 'Query executed successfully';
                if (typeof result === 'string') {
                    addTerminalLine(result, 'terminal-success');
                } else {
                    addTerminalLine(JSON.stringify(result), 'terminal-success');
                }
            }
            addTerminalLine(`<span class="terminal-success">✓ Query successful</span>`);
        } else {
            addTerminalLine(`<span class="terminal-error">✗ Error: ${data.error}</span>`);
        }
    } catch (error) {
        addTerminalLine(`<span class="terminal-error">✗ Request failed: ${error}</span>`);
    }
    
    addToHistory(command);
    terminalInput.value = '';
}

function displayAsTable(data) {
    if (!data || !Array.isArray(data) || data.length === 0) {
        addTerminalLine('Empty result set', 'terminal-success');
        return;
    }
    
    const firstRow = data[0];
    if (!firstRow || typeof firstRow !== 'object') {
        addTerminalLine(JSON.stringify(data), 'terminal-success');
        return;
    }
    
    const table = document.createElement('table');
    table.className = 'terminal-table';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    Object.keys(firstRow).forEach(key => {
        const th = document.createElement('th');
        th.textContent = key;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    const limit = parseInt(rowLimit.value);
    const rowsToShow = Math.min(data.length, limit);
    
    for (let i = 0; i < rowsToShow; i++) {
        const rowData = data[i];
        const row = document.createElement('tr');
        
        Object.values(rowData).forEach(value => {
            const td = document.createElement('td');
            td.textContent = value !== null && value !== undefined ? value : 'NULL';
            row.appendChild(td);
        });
        
        tbody.appendChild(row);
    }
    table.appendChild(tbody);
    
    terminalOutput.appendChild(table);
    
    addTerminalLine(`Showing ${rowsToShow} of ${data.length} row(s)`, 'terminal-success');
    
    if (data.length > limit) {
        addTerminalLine(`Limited to ${limit} rows`, 'terminal-success');
    }
}

function displayAsJson(data) {
    const pre = document.createElement('pre');
    pre.style.cssText = 'background: #252526; padding: 1rem; border-radius: 4px; margin: 1rem 0; white-space: pre-wrap;';
    pre.textContent = JSON.stringify(data, null, 2);
    terminalOutput.appendChild(pre);
}

function clearTerminal() {
    terminalOutput.innerHTML = '';
    addTerminalLine('<span class="terminal-success">=== PesapalDB SQL Terminal ===</span>');
    addTerminalLine('Terminal cleared. Type SQL commands and press Enter.');
}

function showHelp() {
    addTerminalLine('<span class="terminal-success">SQL Commands:</span>');
    addTerminalLine('  SELECT * FROM table_name [WHERE condition]');
    addTerminalLine('  INSERT INTO table_name (col1, col2) VALUES (val1, val2)');
    addTerminalLine('  UPDATE table_name SET col=val [WHERE condition]');
    addTerminalLine('  DELETE FROM table_name [WHERE condition]');
    addTerminalLine('  CREATE TABLE name (col TYPE [PRIMARY KEY|UNIQUE|NOT NULL], ...)');
    addTerminalLine('  DROP TABLE table_name');
    addTerminalLine('  CREATE INDEX idx_name ON table_name(column)');
    addTerminalLine('');
    addTerminalLine('<span class="terminal-success">Special Commands:</span>');
    addTerminalLine('  SCHEMA - Show database schema');
    addTerminalLine('  help  - Show this help');
    addTerminalLine('  clear - Clear terminal');
}

function insertExample(sql) {
    terminalInput.value = sql.replace(/\\'/g, "'");
    terminalInput.focus();
}

updateHistoryDisplay();
</script>
{% endblock %}